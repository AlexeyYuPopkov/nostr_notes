cmake_minimum_required(VERSION 3.10)
project(NostrNotes)

set(CMAKE_CXX_STANDARD 17)

# RU: –í–∫–ª—é—á–∞–µ–º –æ—Ç–ª–∞–¥–æ—á–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
# EN: Enable debug information
set(CMAKE_BUILD_TYPE Debug)
set(CMAKE_CXX_FLAGS_DEBUG "-g -O0")

# RU: –î–æ–±–∞–≤–ª—è–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —Å –∏—Å—Ö–æ–¥–Ω–∏–∫–∞–º–∏
# EN: Add source directories
include_directories(src)

add_subdirectory(secp256k1)

# RU: –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–µ–∂–∏–º —Å–±–æ—Ä–∫–∏
# EN: Define the build mode
if("${CMAKE_SYSTEM_NAME}" STREQUAL "Emscripten")

    message(STATUS "=== üî• Building for WebAssembly with Emscripten ===")

    set(CMAKE_EXECUTABLE_SUFFIX ".wasm")

    # RU: –û–ø—Ä–µ–¥–µ–ª—è–µ–º —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏ –¥–ª—è WebAssembly
    # EN: Specify exported headers for WebAssembly
    add_executable(crypto_module
        src/aes.c
        src/aes_256_cbc.cpp
        src/secp_wrapper.cpp
        src/nip04.cpp
        src/base64/base64.c
        src/base64/cencode.c
        src/base64/cdecode.c
    )

    # RU: –õ–∏–Ω–∫—É–µ–º —Å secp256k1
    # EN: Link with secp256k1
    target_link_libraries(crypto_module PRIVATE secp256k1)

    # RU: –£–∫–∞–∑—ã–≤–∞–µ–º —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
    # EN: Specify exported functions
    file(WRITE ${CMAKE_BINARY_DIR}/exported_functions.txt "
        _encryptAes256Cbc
        _decryptAes256Cbc
        _deriveSharedKey
        _freeMemory
        _nip04encrypt
        _nip04decrypt
        _nip04decryptOld
        _malloc
        _free
        ")

    # target_link_options(crypto_module PRIVATE
    #     "-sSTANDALONE_WASM"
    #     "-sEXPORTED_FUNCTIONS=@${CMAKE_BINARY_DIR}/exported_functions.txt"
    #     "--no-entry"
    # )

    # RU: –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ª–∏–Ω–∫–æ–≤–∫–∏ –¥–ª—è Emscripten
    # EN: Linker settings for Emscripten
    target_link_options(crypto_module PRIVATE
        "-sSTANDALONE_WASM=1"
        "-sEXPORTED_FUNCTIONS=@${CMAKE_BINARY_DIR}/exported_functions.txt"
        "-sEXPORTED_RUNTIME_METHODS=['cwrap','getValue','setValue','UTF8ToString','stringToUTF8','lengthBytesUTF8']"
        "--no-entry"
        "-sENVIRONMENT=web"
        "-sNO_FILESYSTEM=1"
        "-sDISABLE_EXCEPTION_CATCHING=1"
        "-fno-exceptions"
        "-fno-rtti"
        # RU: –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ —Ñ–ª–∞–≥–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã –±–µ–∑ WASI
        # EN: Minimal flags for WASI-free operation
        "-sASSERTIONS=0"
        "-Os"
        "-sERROR_ON_UNDEFINED_SYMBOLS=0"
        "-sMALLOC=emmalloc"
        "-sALLOW_UNIMPLEMENTED_SYSCALLS=1"
    )

    # RU: –í–∫–ª—é—á–∞–µ–º –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –¥–ª—è WebAssembly
    # EN: Enable optimizations for WebAssembly
    target_include_directories(crypto_module PRIVATE 
        ${CMAKE_SOURCE_DIR}/src
        ${CMAKE_SOURCE_DIR}/secp256k1/include
        ${CMAKE_SOURCE_DIR}/src/base64
    )
    

# RU: –°–±–æ—Ä–∫–∞ –¥–ª—è WebAssembly —Å Emscripten
# EN: Build for WebAssembly with Emscripten
# rm -rf build-wasm
# mkdir build-wasm
# cd build-wasm
# emcmake cmake ..
# emmake make

# rm -rf build-wasm && mkdir build-wasm && cd build-wasm
# emcmake cmake .. && emmake make && cd ../

# RU: –∑–∞–≥–ª—É—à–∏—Ç—å fprintf, —á—Ç–æ–±—ã —É–±—Ä–∞—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç WASI
# EN: stub out fprintf to remove WASI dependencies
# secp256k1/src/util.h
# ifdef __EMSCRIPTEN__
# include <stdio.h>
# define printf(...) ((void)0)
# define fprintf(...) ((void)0)
# endif

# RU: –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç WASI
# EN: Check for WASI dependencies
# wasm-objdump -x crypto_module.wasm | grep wasi


# cd secp256k1
# emconfigure ./autogen.sh
# emconfigure ./configure --disable-benchmark --disable-tests --disable-examples --disable-cli --enable-module-ecdh --enable-module-recovery
# emmake make clean
# emmake make

else()
    # RU: –û—Å–Ω–æ–≤–Ω–∞—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞
    # EN: Main library
    add_library(aes_256_cbc_lib 
        src/aes_256_cbc.cpp
        src/aes.c  
        src/secp_wrapper.cpp
        src/nip04.cpp
        src/tools.cpp
        src/base64/base64.c
        src/base64/cencode.c
        src/base64/cdecode.c
    )

    # RU: –õ–∏–Ω–∫—É–µ–º —Å secp256k1
    # EN: Link with secp256k1
    target_link_libraries(aes_256_cbc_lib PRIVATE secp256k1)

    # RU: –û—Å–Ω–æ–≤–Ω–æ–π –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–π —Ñ–∞–π–ª
    # EN: Main executable
    add_executable(main src/main.cpp)
    target_link_libraries(main aes_256_cbc_lib)

    # RU: –í–∫–ª—é—á–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —Å –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏
    # EN: Include header directories
    target_include_directories(aes_256_cbc_lib PRIVATE 
        ${CMAKE_SOURCE_DIR}/src
        ${CMAKE_SOURCE_DIR}/secp256k1/include
        ${CMAKE_SOURCE_DIR}/src/base64
    )

    # RU: –í–∫–ª—é—á–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —Å –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏
    # EN: Include header directories
    target_include_directories(main PRIVATE
        ${CMAKE_SOURCE_DIR}/src
        ${CMAKE_SOURCE_DIR}/secp256k1/include
        ${CMAKE_SOURCE_DIR}/src/base64
    )

    # ==== CATCH2 ====

    # RU: –ü–æ–¥–∫–ª—é—á–∞–µ–º Catch2 (—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–π —á–µ—Ä–µ–∑ brew)
    # EN: Include Catch2 (installed via brew)
    set(CMAKE_PREFIX_PATH "/opt/homebrew/share/catch2")

    find_package(Catch2 3 REQUIRED)

    # RU: –¢–µ—Å—Ç–æ–≤—ã–π –±–∏–Ω–∞—Ä–Ω–∏–∫
    # EN: Test binary
    add_executable(test_aes_256_cbc tests/test_aes_256_cbc.cpp)
    add_executable(test_secp_wrapper tests/test_secp_wrapper.cpp)
    add_executable(test_nip04 tests/test_nip04.cpp)
    add_executable(test_base64 tests/test_base64.cpp)
    
    target_link_libraries(test_aes_256_cbc PRIVATE aes_256_cbc_lib Catch2::Catch2WithMain)
    target_link_libraries(test_secp_wrapper PRIVATE aes_256_cbc_lib Catch2::Catch2WithMain)
    target_link_libraries(test_nip04 PRIVATE aes_256_cbc_lib Catch2::Catch2WithMain)
    target_link_libraries(test_base64 PRIVATE aes_256_cbc_lib Catch2::Catch2WithMain)
    
    target_include_directories(test_aes_256_cbc PRIVATE ${CMAKE_SOURCE_DIR}/src ${CMAKE_SOURCE_DIR}/src/base64)
    target_include_directories(test_secp_wrapper PRIVATE ${CMAKE_SOURCE_DIR}/src ${CMAKE_SOURCE_DIR}/src/base64)
    target_include_directories(test_nip04 PRIVATE ${CMAKE_SOURCE_DIR}/src ${CMAKE_SOURCE_DIR}/src/base64)
    target_include_directories(test_base64 PRIVATE ${CMAKE_SOURCE_DIR}/src ${CMAKE_SOURCE_DIR}/src/base64)

    # RU: –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º —Ç–µ—Å—Ç—ã –¥–ª—è ctest
    # EN: Register tests for ctest
    include(CTest)
    include(Catch)
    catch_discover_tests(test_aes_256_cbc)
    catch_discover_tests(test_secp_wrapper)
    catch_discover_tests(test_nip04)


# rm -rf build && mkdir build && cd build
# cmake .. && cmake --build . && cd ../

endif()