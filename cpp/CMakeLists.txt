cmake_minimum_required(VERSION 3.10)
project(NostrNotes)

set(CMAKE_CXX_STANDARD 17)

# –í–∫–ª—é—á–∞–µ–º –æ—Ç–ª–∞–¥–æ—á–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
set(CMAKE_BUILD_TYPE Debug)
set(CMAKE_CXX_FLAGS_DEBUG "-g -O0")

# set(EMCC_ROOT_DIR "/opt/homebrew/Cellar/emscripten/3.1.50/libexec/system/include")

# –î–æ–±–∞–≤–ª—è–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —Å –∏—Å—Ö–æ–¥–Ω–∏–∫–∞–º–∏
include_directories(src)

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–µ–∂–∏–º —Å–±–æ—Ä–∫–∏
if("${CMAKE_SYSTEM_NAME}" STREQUAL "Emscripten")

    message(STATUS "=== üî• Building for WebAssembly with Emscripten ===")

    set(CMAKE_EXECUTABLE_SUFFIX ".wasm")

    # set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -s EXPORTED_FUNCTIONS='[\"_someFunction\",\"_encryptAes256Cbc\", \"_decryptAes256Cbc\", \"_malloc\", \"_free\"]'")
    # set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -s EXPORTED_RUNTIME_METHODS='[\"ccall\", \"cwrap\"]'")

    # –î–æ–±–∞–≤–ª—è–µ–º tiny-AES –∏ –æ–±—ë—Ä—Ç–∫—É
    add_executable(aes_module
        src/aes.c
        src/aes_256_cbc.cpp
        # src/wrapper.cpp
    )

    # target_link_options(aes_module PRIVATE
    #     "-sWASM=1"
    #     "-sMODULARIZE=1"
    #     "-sENVIRONMENT=web"
    #     "-sEXPORTED_FUNCTIONS=[\"_encryptAes256Cbc\",\"_decryptAes256Cbc\",\"_malloc\",\"_free\"]"
    #     "-sEXPORTED_RUNTIME_METHODS=[\"ccall\",\"cwrap\"]"
    # )

    target_link_options(aes_module PRIVATE
        "-sSTANDALONE_WASM"
        "-sEXPORTED_FUNCTIONS=[\"_someFunction\",\"_encryptAes256Cbc\",\"_decryptAes256Cbc\",\"_freeMemory\",\"_malloc\", \"_free\"]"
        "-sERROR_ON_UNDEFINED_SYMBOLS=0"
        "--no-entry"
    )

    target_include_directories(aes_module PRIVATE ${CMAKE_SOURCE_DIR}/src)

# –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—É—é —Å–±–æ—Ä–∫—É
# rm -rf build-wasm
# mkdir build-wasm
# cd build-wasm
# emcmake cmake ..
# emmake make

# rm -rf build-wasm && mkdir build-wasm && cd build-wasm && emcmake cmake .. && emmake make

else()
    # –û—Å–Ω–æ–≤–Ω–∞—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞
    add_library(aes_256_cbc_lib 
        src/aes_256_cbc.cpp
        src/aes.c  # –î–æ–±–∞–≤–ª—è–µ–º AES —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é
    )
    # target_include_directories(aes_256_cbc_lib)
    # target_link_libraries(aes_256_cbc_lib)

    # –û—Å–Ω–æ–≤–Ω–æ–π –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–π —Ñ–∞–π–ª
    add_executable(main src/main.cpp)
    target_link_libraries(main aes_256_cbc_lib)

    # ==== CATCH2 ====

    # –ü–æ–¥–∫–ª—é—á–∞–µ–º Catch2 (—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–π —á–µ—Ä–µ–∑ brew)
    set(CMAKE_PREFIX_PATH "/opt/homebrew/share/catch2")

    find_package(Catch2 3 REQUIRED)

    # –¢–µ—Å—Ç–æ–≤—ã–π –±–∏–Ω–∞—Ä–Ω–∏–∫
    add_executable(tests tests/test_main.cpp)
    target_link_libraries(tests PRIVATE aes_256_cbc_lib Catch2::Catch2WithMain)

    # –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º —Ç–µ—Å—Ç—ã –¥–ª—è ctest
    include(CTest)
    include(Catch)
    catch_discover_tests(tests)

endif()